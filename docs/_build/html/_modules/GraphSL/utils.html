<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GraphSL.utils &mdash; GraphSL 0.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=a0e24af7"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GraphSL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">GraphSL</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GraphSL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">GraphSL.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for GraphSL.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">ndlib.models.ModelConfig</span> <span class="k">as</span> <span class="nn">mc</span>
<span class="kn">import</span> <span class="nn">ndlib.models.epidemics</span> <span class="k">as</span> <span class="nn">ep</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">random_split</span>


<div class="viewcode-block" id="download_dataset">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.download_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">download_dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download datasets from url.</span>

<span class="sd">    Args:</span>

<span class="sd">    - data_dir (str): The directory where the downloaded dataset files are stored.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">api_url</span> <span class="o">=</span><span class="s2">&quot;https://api.github.com/repos/xianggebenben/graphsl/contents/data?ref=main&quot;</span>

        <span class="c1"># Send a request to fetch the folder contents</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># Raise an exception for HTTP errors</span>

    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/&quot;</span>

    <span class="c1"># Ensure the output directory exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="c1"># Check if response content type is JSON</span>
    <span class="k">if</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">folder_contents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response is not in JSON format. Response text:</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Process the contents of the folder</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">folder_contents</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="c1"># Download the file</span>
            <span class="n">download_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;download_url&#39;</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">file_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">download_url</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_dataset">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.load_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a dataset from a pickle file.</span>

<span class="sd">    Args:</span>

<span class="sd">    - dataset (str): The name of the dataset file, &#39;karate&#39;, &#39;dolphins&#39;, &#39;jazz&#39;, &#39;netscience&#39;, &#39;cora_ml&#39;, &#39;power_grid&#39;.</span>

<span class="sd">    - data_dir (str): The directory where the dataset files are stored.</span>

<span class="sd">    Returns:</span>

<span class="sd">    - graph (dict): A dictionary containing the dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/&quot;</span> <span class="o">+</span> <span class="n">dataset</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span></div>



<div class="viewcode-block" id="generate_seed_vector">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.generate_seed_vector">[docs]</a>
<span class="k">def</span> <span class="nf">generate_seed_vector</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">,</span> <span class="n">seed_num</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a seed vector for diffusion simulation.</span>

<span class="sd">    Args:</span>

<span class="sd">    - top_nodes (list): List of top nodes based on node degree.</span>

<span class="sd">    - seed_num (int): Number of seed nodes.</span>

<span class="sd">    - G (networkx.Graph): The graph object.</span>

<span class="sd">    - random_seed (int): Random Seed</span>

<span class="sd">    Returns:</span>

<span class="sd">        seed_vector (list): Seed vector for diffusion simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">seed_nodes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">,</span> <span class="n">seed_num</span><span class="p">)</span>
    <span class="n">seed_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">seed_nodes</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">seed_vector</span></div>



<div class="viewcode-block" id="diffusion_generation">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.diffusion_generation">[docs]</a>
<span class="k">def</span> <span class="nf">diffusion_generation</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span>
        <span class="n">sim_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">diff_type</span><span class="o">=</span><span class="s1">&#39;IC&#39;</span><span class="p">,</span>
        <span class="n">time_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">repeat_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">seed_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">infect_prob</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">recover_prob</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate diffusion matrices for a graph.</span>

<span class="sd">    Args:</span>

<span class="sd">    - graph (dict): Dictionary containing the graph information.</span>

<span class="sd">    - sim_num (int): Number of simulations.</span>

<span class="sd">    - diff_type (str): Type of diffusion model (IC, LT, SI, SIS, SIR). IC stands for Independent Cascade, LT stands for Linear Threshold, SI stands for Susceptible or Infective, SIS stands for Susceptible or Infective or Susceptible, SIR stands for Susceptible or Infective or Recovered.</span>

<span class="sd">    - time_step (int): Number of time steps in the simulation.</span>

<span class="sd">    - repeat_step (int): Number of repetitions for each simulation.</span>

<span class="sd">    - seed_ratio (float): Ratio of seed nodes, should be between 0 and 0.3.</span>

<span class="sd">    - infect_prob (float): Infection probability,  used in SIS, SIR or SI.</span>

<span class="sd">    - recover_prob (float): Recovery probability, used in SIS or SIR.</span>

<span class="sd">    - threshold (float): Threshold parameter for diffusion models, used in IC or LT.</span>

<span class="sd">    - random_seed (int): Random seed.</span>

<span class="sd">    Returns:</span>

<span class="sd">    - dataset (dict): Dictionary containing (&#39;adj_mat&#39;) adjacency matrix (the dimensionality is number of nodes * number of nodes) and (&#39;diff_mat&#39;) diffusion matrices (the dimensionality is number of simulations * number of nodes * 2(the first column is the source vector, and the second column is the diffusion vector)).</span>

<span class="sd">    Example:</span>

<span class="sd">    import os</span>

<span class="sd">    curr_dir = os.getcwd()</span>

<span class="sd">    from data.utils import load_dataset, diffusion_generation</span>

<span class="sd">    data_name = &#39;karate&#39;</span>

<span class="sd">    graph = load_dataset(data_name, data_dir=curr_dir)</span>

<span class="sd">    dataset = diffusion_generation(graph=graph, infect_prob=0.3, diff_type=&#39;IC&#39;, sim_num=100, seed_ratio=0.1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adj_mat</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s1">&#39;adj_mat&#39;</span><span class="p">]</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_scipy_sparse_array</span><span class="p">(</span><span class="n">adj_mat</span><span class="p">)</span>
    <span class="n">node_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
    <span class="n">seed_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seed_ratio</span> <span class="o">*</span> <span class="n">node_num</span><span class="p">)</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">degree_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">degree</span><span class="p">())</span>
    <span class="n">degree_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">top_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">degree_list</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">degree_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)]]</span>

    <span class="k">assert</span> <span class="n">seed_ratio</span><span class="o">&lt;=</span><span class="mf">0.3</span> <span class="ow">and</span> <span class="n">seed_ratio</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;seed_ratio should be between 0 and 0.3&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sim_num</span><span class="p">):</span>
        <span class="n">seed_vector</span> <span class="o">=</span> <span class="n">generate_seed_vector</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">,</span> <span class="n">seed_num</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
        <span class="n">inf_vec_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">node_num</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">Configuration</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat_step</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;LT&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">ThresholdModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">random_seed</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">add_node_configuration</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;IC&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">IndependentCascadesModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">random_seed</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">add_edge_configuration</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;SIS&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">SISModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">random_seed</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_model_parameter</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">infect_prob</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_model_parameter</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="n">recover_prob</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;SIR&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">SIRModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">random_seed</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_model_parameter</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">infect_prob</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_model_parameter</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">recover_prob</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;SI&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">SIModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">random_seed</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_model_parameter</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">infect_prob</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only IC, LT, SI, SIR and SIS are supported.&#39;</span><span class="p">)</span>

            <span class="n">config</span><span class="o">.</span><span class="n">add_model_initial_configuration</span><span class="p">(</span><span class="s2">&quot;Infected&quot;</span><span class="p">,</span> <span class="n">seed_vector</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">set_initial_status</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="n">iterations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">iteration_bunch</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>

            <span class="n">node_status</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
                <span class="n">node_status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iterations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>

            <span class="n">inf_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">node_status</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">inf_vec</span><span class="p">[</span><span class="n">inf_vec</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">inf_vec_all</span> <span class="o">+=</span> <span class="n">inf_vec</span>

        <span class="n">inf_vec_all</span> <span class="o">=</span> <span class="n">inf_vec_all</span> <span class="o">/</span> <span class="n">repeat_step</span>

        <span class="n">simulation</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seed_vector</span><span class="p">,</span> <span class="n">inf_vec_all</span><span class="p">])</span>

    <span class="n">simulation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;adj_mat&#39;</span><span class="p">:</span> <span class="n">adj_mat</span><span class="p">,</span> <span class="s1">&#39;diff_mat&#39;</span><span class="p">:</span> <span class="n">simulation</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">dataset</span></div>



<div class="viewcode-block" id="split_dataset">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.split_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">split_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">train_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the dataset into training and testing sets.</span>

<span class="sd">    Args:</span>

<span class="sd">    - dataset (dict): Dictionary containing the dataset.</span>

<span class="sd">    - train_ratio (float): Ratio of training data. Default is 0.6.</span>

<span class="sd">    - seed (int): Random seed for reproducibility. Default is 0.</span>

<span class="sd">    Returns:</span>

<span class="sd">    - adj (scipy.sparse.csr_matrix): The adjacency matrix of the graph.</span>

<span class="sd">    - train_dataset (torch.utils.data.dataset.Subset): The train dataset (number of simulations * number of graph nodes * 2(the first column is seed vector and the second column is diffusion vector)).</span>

<span class="sd">    - test_dataset (torch.utils.data.dataset.Subset): The test dataset (number of simulations * number of graph nodes * 2(the first column is seed vector and the second column is diffusion vector)).</span>

<span class="sd">    Example:</span>

<span class="sd">    import os</span>

<span class="sd">    curr_dir = os.getcwd()</span>

<span class="sd">    from data.utils import load_dataset, diffusion_generation, split_dataset</span>

<span class="sd">    data_name = &#39;karate&#39;</span>

<span class="sd">    graph = load_dataset(data_name, data_dir = curr_dir)</span>

<span class="sd">    dataset = diffusion_generation(graph=graph, infect_prob=0.3, diff_type=&#39;IC&#39;, sim_num=100, seed_ratio=0.1)</span>

<span class="sd">    adj, train_dataset, test_dataset =split_dataset(dataset)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;adj_mat&#39;</span><span class="p">]</span>
    <span class="n">diff_mat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;diff_mat&#39;</span><span class="p">])</span>
    <span class="n">all_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_mat</span><span class="p">)</span>
    <span class="n">train_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_num</span> <span class="o">*</span> <span class="n">train_ratio</span><span class="p">)</span>
    <span class="n">test_num</span> <span class="o">=</span> <span class="n">all_num</span> <span class="o">-</span> <span class="n">train_num</span>
    <span class="n">train_diff_mat</span><span class="p">,</span> <span class="n">test_diff_mat</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span>
        <span class="n">diff_mat</span><span class="p">,</span> <span class="p">[</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">],</span> <span class="n">generator</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">adj</span><span class="p">,</span> <span class="n">train_diff_mat</span><span class="p">,</span> <span class="n">test_diff_mat</span></div>



<div class="viewcode-block" id="visualize_source_prediction">
<a class="viewcode-back" href="../../GraphSL.html#GraphSL.utils.visualize_source_prediction">[docs]</a>
<span class="k">def</span> <span class="nf">visualize_source_prediction</span><span class="p">(</span><span class="n">adj</span><span class="p">:</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize source predictions.</span>

<span class="sd">    Args:</span>

<span class="sd">    - adj (csr_matrix): Dictionary containing the dataset.</span>

<span class="sd">    - predictions (numpy array): Predicted source vector.</span>

<span class="sd">    - labels (numpy array): labeled source vector.</span>

<span class="sd">    - save_dir (str):  Dirctory of the saved figure.</span>

<span class="sd">    - save_name (str): Name of the saved figure.</span>


<span class="sd">    Example:</span>

<span class="sd">    from GraphSL.GNN.GCNSI.main import GCNSI</span>

<span class="sd">    from GraphSL.utils import load_dataset, diffusion_generation, split_dataset,download_dataset,visualize_source_prediction</span>

<span class="sd">    import os</span>

<span class="sd">    curr_dir = os.getcwd()</span>

<span class="sd">    download_dataset(curr_dir)</span>

<span class="sd">    data_name = &#39;karate&#39;</span>

<span class="sd">    graph = load_dataset(data_name, data_dir=curr_dir)</span>

<span class="sd">    dataset = diffusion_generation(graph=graph, infect_prob=0.3, diff_type=&#39;IC&#39;, sim_num=100, seed_ratio=0.2)</span>

<span class="sd">    adj, train_dataset, test_dataset = split_dataset(dataset)</span>

<span class="sd">    print(&quot;GCNSI:&quot;)</span>

<span class="sd">    gcnsi = GCNSI()</span>

<span class="sd">    gcnsi_model, thres, auc, f1, pred = gcnsi.train(adj, train_dataset)</span>

<span class="sd">    print(f&quot;train auc: {auc:.3f}, train f1: {f1:.3f}&quot;)</span>

<span class="sd">    pred = (pred &gt;= thres)</span>
<span class="sd">    </span>
<span class="sd">    visualize_source_prediction(adj,pred[:,0],train_dataset[0][:,0].numpy(),save_dir=curr_dir,save_name=&quot;GCNSI_source_prediction&quot;)</span>

<span class="sd"> &quot;&quot;&quot;</span>

    <span class="c1"># Convert the adjacency matrix to a NetworkX graph</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_scipy_sparse_array</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    
    <span class="c1"># Determine the number of nodes</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Check that predictions and labels have the same length as the number of nodes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_nodes</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_nodes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of predictions and labels must match the number of nodes in the graph.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Set up the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Define the layout for the graph</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="c1"># Plot the predictions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Predicted Sources&quot;</span><span class="p">)</span>
    <span class="n">pred_patch_0</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Not Source&#39;</span><span class="p">)</span>
    <span class="n">pred_patch_1</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">pred_patch_0</span><span class="p">,</span> <span class="n">pred_patch_1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    
    
    <span class="c1"># Plot the true labels</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;True Sources&quot;</span><span class="p">)</span>
    <span class="n">label_patch_0</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Not Source&#39;</span><span class="p">)</span>
    <span class="n">label_patch_1</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">label_patch_0</span><span class="p">,</span> <span class="n">label_patch_1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    

    
    <span class="c1"># Show the plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save the figure to the specified directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Junxiang Wang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>